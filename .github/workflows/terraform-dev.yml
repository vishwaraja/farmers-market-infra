# =============================================================================
# TERRAFORM DEV ENVIRONMENT CI/CD
# =============================================================================
# This workflow automatically deploys changes to the dev environment
# Triggers: Push to dev branch, PR to dev branch

name: ðŸš€ Terraform Dev Environment

on:
  push:
    branches: [dev]
    paths:
      - 'environments/dev/**'
      - 'modules/**'
      - 'shared/**'
  pull_request:
    branches: [dev]
    paths:
      - 'environments/dev/**'
      - 'modules/**'
      - 'shared/**'

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-east-1'
  ENVIRONMENT: 'dev'

jobs:
  # =============================================================================
  # VALIDATION JOB
  # =============================================================================
  validate:
    name: âœ… Terraform Validation & Security
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ðŸ” Terraform Format Check
      run: terraform fmt -check -recursive
      
    - name: ðŸ”§ Terraform Init
      run: terraform init
      working-directory: environments/dev
      
    - name: âœ… Terraform Validate
      run: terraform validate
      working-directory: environments/dev
      
    - name: ðŸ”§ TFLint Setup
      uses: terraform-linters/setup-tflint@v3
      with:
        tflint_version: latest
        
    - name: ðŸ” Run TFLint
      run: tflint
      working-directory: environments/dev
      
    - name: ðŸ”’ Checkov Security Scan
      uses: bridgecrewio/checkov-action@master
      with:
        directory: environments/dev
        framework: terraform
        output_format: sarif
        output_file_path: checkov.sarif
        
    - name: ðŸ“¤ Upload Checkov Results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: checkov.sarif

  # =============================================================================
  # PLAN JOB
  # =============================================================================
  plan:
    name: ðŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ðŸ”‘ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ðŸ”§ Terraform Init
      run: terraform init
      working-directory: environments/dev
      
    - name: ðŸ“‹ Terraform Plan
      run: terraform plan -out=tfplan
      working-directory: environments/dev
      
    - name: ðŸ“¤ Upload Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan-dev
        path: environments/dev/tfplan
        retention-days: 1

  # =============================================================================
  # APPLY JOB (Auto-deploy to dev)
  # =============================================================================
  apply:
    name: ðŸš€ Terraform Apply
    runs-on: ubuntu-latest
    needs: [validate, plan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    environment: development
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ðŸ”‘ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ðŸ“¥ Download Plan Artifact
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan-dev
        path: environments/dev
        
    - name: ðŸ”§ Terraform Init
      run: terraform init
      working-directory: environments/dev
      
    - name: ðŸš€ Terraform Apply
      run: terraform apply tfplan
      working-directory: environments/dev
      
    - name: ðŸ“Š Get Outputs
      id: outputs
      run: |
        echo "kong_proxy_url=$(terraform output -raw kong_proxy_url)" >> $GITHUB_OUTPUT
        echo "eks_cluster_name=$(terraform output -raw eks_cluster_name)" >> $GITHUB_OUTPUT
        echo "storage_bucket_name=$(terraform output -raw storage_bucket_name)" >> $GITHUB_OUTPUT
      working-directory: environments/dev
      
    - name: ðŸ§ª Test Infrastructure
      run: |
        echo "ðŸ§ª Testing deployed infrastructure..."
        
        # Wait for resources to be ready
        sleep 30
        
        # Test Kong API Gateway
        echo "Testing Kong API Gateway..."
        curl -f "${{ steps.outputs.outputs.kong_proxy_url }}/status" || {
          echo "âŒ Kong health check failed"
          exit 1
        }
        echo "âœ… Kong is healthy"
        
        # Test EKS cluster
        echo "Testing EKS cluster..."
        aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ steps.outputs.outputs.eks_cluster_name }}
        kubectl get nodes || {
          echo "âŒ EKS cluster test failed"
          exit 1
        }
        echo "âœ… EKS cluster is healthy"
        
        # Test S3 bucket
        echo "Testing S3 bucket..."
        aws s3 ls "s3://${{ steps.outputs.outputs.storage_bucket_name }}" || {
          echo "âŒ S3 bucket test failed"
          exit 1
        }
        echo "âœ… S3 bucket is accessible"
        
        echo "ðŸŽ‰ All infrastructure tests passed!"
      working-directory: environments/dev
      
    - name: ðŸ“¢ Notify Success
      uses: 8398a7/action-slack@v3
      if: success()
      with:
        status: success
        channel: '#terraform-changes'
        text: |
          ðŸš€ **Dev Environment Deployed Successfully**
          
          **Environment:** dev
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Kong URL:** ${{ steps.outputs.outputs.kong_proxy_url }}
          
          All infrastructure tests passed! âœ…
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        
    - name: ðŸ“¢ Notify Failure
      uses: 8398a7/action-slack@v3
      if: failure()
      with:
        status: failure
        channel: '#terraform-changes'
        text: |
          âŒ **Dev Environment Deployment Failed**
          
          **Environment:** dev
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          
          Check the logs for details.
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # =============================================================================
  # PR COMMENT JOB
  # =============================================================================
  pr-comment:
    name: ðŸ’¬ Comment PR
    runs-on: ubuntu-latest
    needs: [validate, plan]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download Plan Artifact
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan-dev
        path: environments/dev
        
    - name: ðŸ“Š Generate Plan Output
      id: plan-output
      run: |
        cd environments/dev
        terraform init
        terraform show tfplan > plan.txt
        echo "plan_output<<EOF" >> $GITHUB_OUTPUT
        cat plan.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      shell: bash
      
    - name: ðŸ’¬ Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const planOutput = `${{ steps.plan-output.outputs.plan_output }}`;
          
          const comment = `## ðŸš€ Terraform Plan Results - Dev Environment
          
          <details>
          <summary>Click to expand plan output</summary>
          
          \`\`\`hcl
          ${planOutput}
          \`\`\`
          
          </details>
          
          **Validation:** âœ… Passed
          **Security Scan:** âœ… Passed
          **Plan:** âœ… Generated
          
          This plan will be automatically applied when merged to the \`dev\` branch.
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
